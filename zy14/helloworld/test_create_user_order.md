# CreateUserOrder 函数测试文档

## 功能概述

`CreateUserOrder` 函数实现了完整的滴滴打车用户叫车功能，包括：

1. **参数验证** - 验证乘客ID、出发地址、订单状态等参数
2. **用户验证** - 验证用户是否存在
3. **订单冲突检查** - 检查用户是否有未完成的订单
4. **价格计算** - 根据地址和时间计算预估价格
5. **订单创建** - 创建订单并保存到数据库
6. **错误处理** - 完善的错误码和错误信息

## API 接口

### 请求
```bash
POST /v1/order/userOrder
Content-Type: application/json
```

### 请求参数
```json
{
  "passenger_id": 1,           // 乘客用户ID（必填）
  "order_status": 1,           // 订单状态（必填，用户叫车时固定为1）
  "start_address": "北京市朝阳区三里屯太古里",  // 出发地址（必填）
  "order_time": "2024-01-15 14:30:00"  // 下单时间（可选，不填则使用当前时间）
}
```

## 测试用例

### 1. 正常叫车场景

**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里",
  "order_time": "2024-01-15 14:30:00"
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "创建订单成功，订单ID: 1，预估价格: 15.50元"
}
```

### 2. 参数验证测试

#### 2.1 乘客ID无效
**请求：**
```json
{
  "passenger_id": 0,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里"
}
```

**预期响应：**
```json
{
  "code": 10001,
  "message": "乘客ID无效"
}
```

#### 2.2 出发地址为空
**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 1,
  "start_address": ""
}
```

**预期响应：**
```json
{
  "code": 10002,
  "message": "出发地址不能为空"
}
```

#### 2.3 订单状态错误
**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 2,
  "start_address": "北京市朝阳区三里屯太古里"
}
```

**预期响应：**
```json
{
  "code": 10003,
  "message": "订单状态错误，用户叫车时状态应为待接单"
}
```

### 3. 业务逻辑测试

#### 3.1 用户不存在
**请求：**
```json
{
  "passenger_id": 999,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里"
}
```

**预期响应：**
```json
{
  "code": 10004,
  "message": "用户不存在"
}
```

#### 3.2 有未完成订单
**前提：** 用户ID为1的用户已有状态为1、2或3的订单

**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里"
}
```

**预期响应：**
```json
{
  "code": 10005,
  "message": "您有未完成的订单，请先完成当前订单"
}
```

### 4. 时间处理测试

#### 4.1 不提供下单时间
**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里"
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "创建订单成功，订单ID: 2，预估价格: 15.50元"
}
```

#### 4.2 提供错误格式的时间
**请求：**
```json
{
  "passenger_id": 1,
  "order_status": 1,
  "start_address": "北京市朝阳区三里屯太古里",
  "order_time": "2024-01-15 14:30"
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "创建订单成功，订单ID: 3，预估价格: 15.50元"
}
```

## 价格计算逻辑

### 基础算法
- **基础价格**: 10元
- **距离因素**: 地址长度 × 0.5
- **时间因素**: 高峰时段（7-9点，17-19点）加价20%
- **价格范围**: 最低8元，最高100元

### 计算示例

#### 示例1：普通时段，短地址
- 地址：北京市朝阳区三里屯太古里（长度：15字符）
- 时间：14:30（非高峰时段）
- 计算：10 + (15 × 0.5) × 1.0 = 17.5元

#### 示例2：高峰时段，长地址
- 地址：北京市海淀区中关村大街1号（长度：18字符）
- 时间：8:30（高峰时段）
- 计算：(10 + (18 × 0.5)) × 1.2 = 22.8元

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 10001 | 乘客ID无效 |
| 10002 | 出发地址不能为空 |
| 10003 | 订单状态错误，用户叫车时状态应为待接单 |
| 10004 | 用户不存在 |
| 10005 | 您有未完成的订单，请先完成当前订单 |
| 10006 | 创建订单失败 |

## 数据库影响

调用成功后，会在 `order_info` 表中创建一条新记录，包含：

- `passenger_id`: 乘客ID
- `order_status`: 1（待接单）
- `start_address`: 出发地址
- `order_time`: 下单时间
- `price`: 预估价格
- `create_time`: 创建时间
- `update_time`: 更新时间

## 注意事项

1. **订单状态**: 用户叫车时，订单状态必须为1（待接单）
2. **用户验证**: 系统会验证乘客ID对应的用户是否存在
3. **冲突检查**: 系统会检查用户是否有未完成的订单（状态1、2、3）
4. **价格计算**: 当前使用简单算法，实际项目中应集成地图API
5. **时间处理**: 如果不提供下单时间或格式错误，会使用当前时间
6. **扩展性**: 函数预留了推送通知给司机的接口位置

## 后续扩展建议

1. **地图集成**: 集成高德地图或百度地图API进行真实距离计算
2. **实时定位**: 添加用户当前位置获取功能
3. **车型选择**: 支持不同车型的价格计算
4. **优惠券**: 支持优惠券和促销活动
5. **消息推送**: 集成推送服务通知附近司机
6. **风控检查**: 添加异常订单检测机制 